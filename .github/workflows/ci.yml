name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  NODE_VERSION: '22'

jobs:
  build-backend:
    name: Build & Test (.NET)
    runs-on: [self-hosted, Linux, X64]

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: pitbull
          POSTGRES_PASSWORD: pitbull_dev
          POSTGRES_DB: pitbull_test
        ports:
          # Map container 5432 -> an ephemeral host port (avoids clashes on self-hosted runners)
          - 5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v6
        with:
          clean: true

      - name: Clean stale files from previous builds
        run: |
          git clean -ffdx -e node_modules -e .nuget
          # Explicitly remove bin/obj to prevent stale DLLs on self-hosted runner
          find . -type d \( -name 'bin' -o -name 'obj' \) -exec rm -rf {} + 2>/dev/null || true

      - name: Setup .NET (GitHub-hosted runners only)
        if: ${{ runner.environment == 'github-hosted' }}
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Scan for vulnerable packages
        run: |
          echo "::group::NuGet Vulnerability Scan"
          dotnet list package --vulnerable --include-transitive 2>&1 | tee vulnerability-scan.txt
          if grep -q "has the following vulnerable packages" vulnerability-scan.txt; then
            echo "::error::Vulnerable NuGet packages detected!"
            echo "::group::Vulnerable packages found"
            grep -A 20 "has the following vulnerable packages" vulnerability-scan.txt
            echo "::endgroup::"
            exit 1
          else
            echo "✅ No vulnerable packages detected"
          fi
          echo "::endgroup::"

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Check migrations for dangerous patterns
        run: |
          echo "::group::Migration Safety Check"
          DANGEROUS_PATTERNS=0
          
          # Check for RenameColumn or RenameTable (dangerous in production - can break queries)
          if grep -rE "(RenameColumn|RenameTable)" src/Pitbull.Api/Migrations/*.cs 2>/dev/null; then
            echo "::error::RenameColumn/RenameTable detected - this can break production queries!"
            DANGEROUS_PATTERNS=1
          fi
          
          # Check for Sql() with DROP or TRUNCATE (manual SQL that destroys data)
          if grep -rE 'Sql\s*\(\s*"[^"]*\b(DROP|TRUNCATE)\b' src/Pitbull.Api/Migrations/*.cs 2>/dev/null; then
            echo "::error::Manual DROP/TRUNCATE SQL detected - review carefully!"
            DANGEROUS_PATTERNS=1
          fi
          
          if [ $DANGEROUS_PATTERNS -eq 1 ]; then
            echo "::error::Dangerous migration patterns detected. Review carefully before merging."
            exit 1
          else
            echo "✅ No dangerous migration patterns detected"
          fi
          echo "::endgroup::"

      - name: Run Unit Tests
        run: dotnet test tests/Pitbull.Tests.Unit --no-build --configuration Release --verbosity normal

      - name: Run Integration Tests
        run: dotnet test tests/Pitbull.Tests.Integration --no-build --configuration Release --verbosity normal
        env:
          ConnectionStrings__PitbullDb: "Host=localhost;Port=${{ job.services.postgres.ports[5432] }};Database=pitbull_test;Username=pitbull;Password=pitbull_dev"

  build-frontend:
    name: Build Frontend (Next.js)
    runs-on: [self-hosted, Linux, X64]

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js (GitHub-hosted runners, with cache)
        if: ${{ runner.environment == 'github-hosted' }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: src/Pitbull.Web/pitbull-web/package-lock.json

      - name: Setup Node.js (self-hosted runners)
        if: ${{ runner.environment == 'self-hosted' }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: src/Pitbull.Web/pitbull-web
        run: npm ci

      - name: Audit npm packages for vulnerabilities
        working-directory: src/Pitbull.Web/pitbull-web
        run: |
          echo "::group::npm Vulnerability Audit"
          # Run audit and capture exit code
          if npm audit --audit-level moderate; then
            echo "✅ No moderate+ vulnerabilities detected"
          else
            echo "::error::npm audit found moderate+ vulnerabilities!"
            echo "Run 'npm audit fix' to address auto-fixable issues"
            exit 1
          fi
          echo "::endgroup::"

      - name: Build
        working-directory: src/Pitbull.Web/pitbull-web
        run: npm run build

      - name: Lint
        working-directory: src/Pitbull.Web/pitbull-web
        run: npm run lint
